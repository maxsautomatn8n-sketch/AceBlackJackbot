<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AceBlackJack ‚ô†Ô∏è‚ô•Ô∏è‚ô¶Ô∏è‚ô£Ô∏è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Arial', sans-serif;
            background: 
                repeating-linear-gradient(90deg, rgba(0,0,0,0.03) 0px, transparent 1px, transparent 2px, rgba(0,0,0,0.03) 3px),
                repeating-linear-gradient(0deg, rgba(0,0,0,0.03) 0px, transparent 1px, transparent 2px, rgba(0,0,0,0.03) 3px),
                radial-gradient(ellipse at center, #0d7a3a 0%, #085a2a 50%, #064420 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
            overflow-x: hidden;
            position: relative;
        }

        /* Casino table border */
        body::before {
            content: '';
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 1200px;
            height: calc(100vh - 90px);
            border: 15px solid #8b4513;
            border-radius: 150px;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5), 0 10px 30px rgba(0,0,0,0.4);
            pointer-events: none;
            z-index: 0;
        }

        /* Casino table engraved text - TRUE CENTER between zones */
        body::after {
            content: 'ACEBLACKJACK';
            position: fixed;
            top: 52%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 90px;
            font-weight: bold;
            color: rgba(255, 215, 0, 0.10);
            letter-spacing: 10px;
            z-index: 1;
            pointer-events: none;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3), -1px -1px 0 rgba(255,255,255,0.08);
        }

        /* Suit symbols - MORE VISIBLE */
        .table-suit-tl {
            position: fixed;
            top: 110px;
            left: 110px;
            font-size: 70px;
            color: rgba(255, 215, 0, 0.45);
            z-index: 1;
            pointer-events: none;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }

        .table-suit-tr {
            position: fixed;
            top: 110px;
            right: 110px;
            font-size: 70px;
            color: rgba(255, 215, 0, 0.45);
            z-index: 1;
            pointer-events: none;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }

        .table-suit-bl {
            position: fixed;
            bottom: 110px;
            left: 110px;
            font-size: 70px;
            color: rgba(255, 215, 0, 0.45);
            z-index: 1;
            pointer-events: none;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }

        .table-suit-br {
            position: fixed;
            bottom: 110px;
            right: 110px;
            font-size: 70px;
            color: rgba(255, 215, 0, 0.45);
            z-index: 1;
            pointer-events: none;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }

        /* Engraved DEALER text - ABOVE zone - HIDDEN during betting */
        .table-dealer-label {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 26px;
            font-weight: bold;
            color: rgba(255, 215, 0, 0.25);
            letter-spacing: 8px;
            z-index: 1;
            pointer-events: none;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.4), -1px -1px 0 rgba(255,255,255,0.15);
            display: none;
        }

        /* Engraved PLAYER text - ABOVE zone - HIDDEN during betting */
        .table-player-label {
            position: fixed;
            bottom: 32%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 26px;
            font-weight: bold;
            color: rgba(255, 215, 0, 0.25);
            letter-spacing: 8px;
            z-index: 1;
            pointer-events: none;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.4), -1px -1px 0 rgba(255,255,255,0.15);
            display: none;
        }

        /* Show labels during game */
        body.game-active .table-dealer-label,
        body.game-active .table-player-label {
            display: block;
        }

        .header {
            padding: 15px;
            background: rgba(0,0,0,0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            border-bottom: 2px solid rgba(255,215,0,0.3);
            position: relative;
            z-index: 10;
        }

        .chips-display {
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chip-icon-header {
            width: 35px;
            height: 35px;
            background: linear-gradient(145deg, #FFD700, #FFA500);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5), inset 0 2px 4px rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            position: relative;
        }

        .chip-icon-header::before {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border: 2px dashed rgba(255,255,255,0.6);
            border-radius: 50%;
        }

        .chip-icon-header::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: 
                radial-gradient(circle at 50% 10%, white 1.5px, transparent 1.5px),
                radial-gradient(circle at 85% 25%, white 1.5px, transparent 1.5px),
                radial-gradient(circle at 90% 50%, white 1.5px, transparent 1.5px),
                radial-gradient(circle at 85% 75%, white 1.5px, transparent 1.5px),
                radial-gradient(circle at 50% 90%, white 1.5px, transparent 1.5px),
                radial-gradient(circle at 15% 75%, white 1.5px, transparent 1.5px),
                radial-gradient(circle at 10% 50%, white 1.5px, transparent 1.5px),
                radial-gradient(circle at 15% 25%, white 1.5px, transparent 1.5px);
        }

        /* BETTING SCREEN - BETTER SPACING */
        .betting-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 80px 20px 60px 20px;
            position: relative;
            z-index: 5;
            gap: 70px;
        }

        .betting-title {
            font-size: 32px;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
        }

        .out-of-chips-notice {
            background: rgba(244, 67, 54, 0.2);
            border: 2px solid #f44336;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            max-width: 400px;
        }

        .out-of-chips-notice h3 {
            color: #FFD700;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .out-of-chips-notice p {
            font-size: 16px;
        }

        .current-bet-display {
            font-size: 36px;
            color: #FFD700;
            text-shadow: 0 0 15px rgba(255,215,0,0.6);
            font-weight: bold;
        }

        .chips-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .chip {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 10px rgba(0,0,0,0.5), inset 0 2px 5px rgba(255,255,255,0.3);
            position: relative;
            border: 6px solid white;
        }

        .chip::before {
            content: '';
            position: absolute;
            width: 55px;
            height: 55px;
            border: 2px dashed rgba(255,255,255,0.7);
            border-radius: 50%;
            border-width: 3px;
        }

        .chip::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: 
                radial-gradient(circle at 50% 8%, white 2px, transparent 2px),
                radial-gradient(circle at 85% 20%, white 2px, transparent 2px),
                radial-gradient(circle at 95% 50%, white 2px, transparent 2px),
                radial-gradient(circle at 85% 80%, white 2px, transparent 2px),
                radial-gradient(circle at 50% 92%, white 2px, transparent 2px),
                radial-gradient(circle at 15% 80%, white 2px, transparent 2px),
                radial-gradient(circle at 5% 50%, white 2px, transparent 2px),
                radial-gradient(circle at 15% 20%, white 2px, transparent 2px);
        }

        .chip:hover {
            transform: scale(1.1);
            box-shadow: 0 7px 14px rgba(0,0,0,0.6), inset 0 2px 5px rgba(255,255,255,0.4);
        }

        .chip:active { transform: scale(0.95); }

        .chip-1 { background: linear-gradient(145deg, #FFF, #DDD); color: #333; }
        .chip-5 { background: linear-gradient(145deg, #FF4444, #CC0000); color: white; }
        .chip-10 { background: linear-gradient(145deg, #4169E1, #1E3A8A); color: white; }
        .chip-25 { background: linear-gradient(145deg, #00C853, #007B33); color: white; }
        .chip-50 { background: linear-gradient(145deg, #333, #000); color: white; }

        .chip-value {
            font-size: 22px;
            z-index: 10;
            position: relative;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .betting-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 15px 35px;
            font-size: 18px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        .btn:active { transform: scale(0.95); }
        
        .btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.5);
        }

        .btn-clear { background: #f44336; color: white; }
        .btn-deal { background: #4CAF50; color: white; }
        .btn-buy-chips {
            background: linear-gradient(145deg, #9C27B0, #7B1FA2);
            color: white;
            border: 2px solid #E1BEE7;
        }
        .btn-demo-reset {
            background: linear-gradient(145deg, #FF9800, #F57C00);
            color: white;
            font-size: 14px;
            padding: 10px 20px;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .game-screen {
            display: none;
            flex: 1;
            flex-direction: column;
            position: relative;
            z-index: 5;
        }

        .game-screen.active { display: flex; }

        /* DECK - SAME SIZE AS CARDS - FAR FROM TOP */
        .deck-container {
            position: fixed;
            top: 250px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
        }

        .deck {
            width: 80px;
            height: 115px;
            position: relative;
        }

        .deck-card {
            position: absolute;
            width: 80px;
            height: 115px;
            background: linear-gradient(135deg, #c84a3d 0%, #8b1a2e 100%);
            border-radius: 8px;
            border: 3px solid #1a1a1a;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        .deck-card::before {
            content: '';
            position: absolute;
        }

        .deck-card::after {
            content: 'ACEBLACKJACK';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 7px;
            font-weight: bold;
            color: rgba(255,215,0,0.9);
            letter-spacing: 0.5px;
        }

        .deck-card:nth-child(1) { top: 0; left: 0; }
        .deck-card:nth-child(2) { top: 2px; left: 2px; }
        .deck-card:nth-child(3) { top: 4px; left: 4px; }

        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding: 20px;
            padding-top: 340px;
            max-width: 700px;
            margin: 0 auto;
            width: 100%;
        }

        .dealer-section, .player-section {
            text-align: center;
            margin: 15px 0;
            position: relative;
        }

        .split-hands-wrapper {
            display: flex;
            justify-content: center;
            gap: 60px;
            margin: 20px 0;
        }

        .split-hand {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .split-hand-label {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }

        .split-hand.active .split-hand-label {
            color: #00FF00;
            text-shadow: 0 0 15px rgba(0,255,0,0.9);
            animation: pulse 1s infinite;
        }

        .split-hand.complete {
            opacity: 0.6;
        }

        .split-cards {
            min-height: 115px;
        }

        .dealer-section::before, .player-section::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            height: 160px;
            border: 3px solid rgba(255, 215, 0, 0.25);
            border-radius: 15px;
            pointer-events: none;
            z-index: 0;
            box-shadow: inset 0 0 15px rgba(255,215,0,0.1);
        }

        .section-title {
            font-size: 20px;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
            position: relative;
            z-index: 2;
        }

        .cards {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 15px 0;
            min-height: 115px;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
            z-index: 2;
        }

        .card {
            width: 80px;
            height: 115px;
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 5px 10px rgba(0,0,0,0.4);
            position: relative;
            border: 2px solid #ddd;
            opacity: 0;
            transform: translateY(-20px) scale(0.9);
            animation: cardAppear 0.3s ease-out forwards;
        }

        @keyframes cardAppear {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .card-value {
            font-size: 36px;
            line-height: 1;
            position: relative;
            z-index: 2;
        }
        
        .card-suit {
            font-size: 26px;
            margin-top: 4px;
            position: relative;
            z-index: 2;
        }

        .card.back {
            background: linear-gradient(135deg, #c84a3d 0%, #8b1a2e 100%);
            color: rgba(255,215,0,0.9);
            border: 3px solid #1a1a1a;
            overflow: hidden;
        }

        .card.back::before {
            content: '';
            position: absolute;
        }

        .card.back::after {
            content: 'ACEBLACKJACK';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8px;
            font-weight: bold;
            letter-spacing: 0.8px;
            z-index: 1;
            color: rgba(255,215,0,0.9);
        }

        .card.red { color: #d32f2f; }
        .card.black { color: #000; }

        .score {
            font-size: 19px;
            margin: 10px 0;
            font-weight: bold;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.7);
            position: relative;
            z-index: 2;
        }

        .message {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            padding: 20px 15px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            letter-spacing: 2px;
            position: relative;
            z-index: 2;
        }

        .blackjack-notice {
            font-size: 36px;
            color: #FFD700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.9), 0 0 30px rgba(255, 215, 0, 0.5);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.85; transform: scale(1.08); }
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding: 15px;
            flex-wrap: wrap;
        }

        .btn-hit { background: #4CAF50; color: white; }
        .btn-stand { background: #f44336; color: white; }
        .btn-double { background: #FF9800; color: white; }
        .btn-split { background: #9C27B0; color: white; }
        .btn-insurance { background: #2196F3; color: white; }

        .bet-display {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-size: 18px;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
            z-index: 100;
            font-weight: bold;
            display: none;
        }

        body.game-active .bet-display {
            display: block;
        }

        .bet-display #bet-info {
            margin-bottom: 5px;
        }

        .bet-display #message {
            font-size: 22px;
        }
    </style>
</head>
<body>
    <!-- Casino table elements -->
    <div class="table-suit-tl">‚ô†Ô∏è</div>
    <div class="table-suit-tr">‚ô•Ô∏è</div>
    <div class="table-suit-bl">‚ô¶Ô∏è</div>
    <div class="table-suit-br">‚ô£Ô∏è</div>
    <div class="table-dealer-label">DEALER</div>
    <div class="table-player-label">PLAYER</div>

    <div class="header">
        <div class="chips-display">
            <div class="chip-icon-header">$</div>
            <span id="chips">50</span> chips
        </div>
        <div id="username">Player</div>
    </div>

    <div class="betting-screen" id="betting-screen">
        <div class="betting-title">Place Your Bet</div>
        
        <div id="out-of-chips-notice" class="out-of-chips-notice" style="display: none;">
            <h3>Out of Chips!</h3>
            <p>You need chips to play. Buy more or get free demo chips.</p>
        </div>
        
        <div class="current-bet-display">
            Bet: <span id="current-bet">0</span> chips
        </div>
        
        <div class="chips-container">
            <div class="chip chip-1" onclick="addBet(1)">
                <div class="chip-value">1</div>
            </div>
            <div class="chip chip-5" onclick="addBet(5)">
                <div class="chip-value">5</div>
            </div>
            <div class="chip chip-10" onclick="addBet(10)">
                <div class="chip-value">10</div>
            </div>
            <div class="chip chip-25" onclick="addBet(25)">
                <div class="chip-value">25</div>
            </div>
            <div class="chip chip-50" onclick="addBet(50)">
                <div class="chip-value">50</div>
            </div>
        </div>
        
        <div class="betting-controls">
            <button class="btn btn-clear" onclick="clearBet()">Clear</button>
            <button class="btn btn-deal" id="btn-deal" onclick="dealCards()" disabled>Deal</button>
            <button class="btn btn-buy-chips" onclick="buyChips()">Buy Chips</button>
            <button class="btn btn-demo-reset" onclick="demoReset()" style="display: none;" id="btn-demo">Free Chips (Demo)</button>
        </div>
    </div>

    <div class="game-screen" id="game-screen">
        <div class="bet-display">
            <div id="bet-info"></div>
        </div>

        <div class="deck-container">
            <div class="deck">
                <div class="deck-card"></div>
                <div class="deck-card"></div>
                <div class="deck-card"></div>
            </div>
        </div>

        <div class="game-container">
            <div class="dealer-section">
                <div class="cards" id="dealer-cards"></div>
                <div class="score" id="dealer-score"></div>
            </div>

            <div id="message" class="message"></div>

            <div class="player-section">
                <div id="player-cards-container">
                    <div class="cards" id="player-cards"></div>
                </div>
                <div id="split-container" style="display: none;">
                    <div class="split-hands-wrapper">
                        <div class="split-hand" id="split-hand-0">
                            <div class="split-hand-label">Hand 1</div>
                            <div class="cards split-cards" id="split-cards-0"></div>
                            <div class="score" id="split-score-0"></div>
                        </div>
                        <div class="split-hand" id="split-hand-1">
                            <div class="split-hand-label">Hand 2</div>
                            <div class="cards split-cards" id="split-cards-1"></div>
                            <div class="score" id="split-score-1"></div>
                        </div>
                    </div>
                </div>
                <div class="score" id="player-score"></div>
            </div>
        </div>

        <div class="controls" id="controls"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const userId = tg.initDataUnsafe?.user?.id || 123456;
        const username = tg.initDataUnsafe?.user?.first_name || 'Player';
        
        document.getElementById('username').textContent = username;

        let chips = 50;
        let currentBet = 0;
        let insuranceBet = 0;
        let gameActive = false;
        let canDouble = false;
        let canSplit = false;
        let playerHand = [];
        let dealerHand = [];
        let deck = [];
        
        // Split variables
        let isSplitGame = false;
        let splitHands = [[], []];
        let currentSplitHand = 0;
        let splitBets = [0, 0];
        let splitComplete = [false, false];

        function loadChips() {
            const stored = localStorage.getItem('chips_' + userId);
            chips = stored ? parseInt(stored) : 50;
            updateChipsDisplay();
            checkChipsStatus();
        }

        function updateChipsDisplay() {
            document.getElementById('chips').textContent = chips;
            localStorage.setItem('chips_' + userId, chips);
            checkChipsStatus();
        }

        function checkChipsStatus() {
            const outOfChipsNotice = document.getElementById('out-of-chips-notice');
            const demoBtn = document.getElementById('btn-demo');
            
            if (chips < 10) {
                outOfChipsNotice.style.display = 'block';
                demoBtn.style.display = 'inline-block';
            } else {
                outOfChipsNotice.style.display = 'none';
                demoBtn.style.display = 'none';
            }
        }

        function buyChips() {
            tg.showAlert(
                'Buy Chips\n\n' +
                'To purchase chips, use the /buy command in the Telegram bot.\n\n' +
                'Available packages:\n' +
                '‚Ä¢ 100 chips - $1\n' +
                '‚Ä¢ 500 chips - $5\n' +
                '‚Ä¢ 1000 chips - $10\n\n' +
                'Close this game and type /buy in the chat!'
            );
        }

        function demoReset() {
            chips = 50;
            updateChipsDisplay();
            tg.showAlert('Demo Mode\n\nYou received 50 free chips!\n\n(In production, use /buy to purchase chips)');
        }

        function addBet(amount) {
            if (chips >= amount) {
                currentBet += amount;
                document.getElementById('current-bet').textContent = currentBet;
                document.getElementById('btn-deal').disabled = currentBet === 0;
            } else {
                tg.showAlert('Not enough chips!');
            }
        }

        function clearBet() {
            currentBet = 0;
            document.getElementById('current-bet').textContent = currentBet;
            document.getElementById('btn-deal').disabled = true;
        }

        function dealCards() {
            if (currentBet === 0 || currentBet > chips) return;
            
            chips -= currentBet;
            updateChipsDisplay();
            
            document.getElementById('betting-screen').style.display = 'none';
            document.getElementById('game-screen').classList.add('active');
            document.body.classList.add('game-active');
            
            startGame();
        }

        function backToBetting() {
            playerHand = [];
            dealerHand = [];
            gameActive = false;
            
            // Reset split
            isSplitGame = false;
            splitHands = [[], []];
            currentSplitHand = 0;
            splitBets = [0, 0];
            splitComplete = [false, false];
            
            // Reset display
            document.getElementById('player-cards-container').style.display = 'block';
            document.getElementById('split-container').style.display = 'none';
            document.getElementById('player-score').style.display = 'block';
            
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('betting-screen').style.display = 'flex';
            document.body.classList.remove('game-active');
            clearBet();
        }

        function createDeck() {
            const suits = ['‚ô†Ô∏è', '‚ô•Ô∏è', '‚ô¶Ô∏è', '‚ô£Ô∏è'];
            const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            deck = [];
            for (let suit of suits) {
                for (let value of values) {
                    deck.push({ value, suit, isRed: suit === '‚ô•Ô∏è' || suit === '‚ô¶Ô∏è' });
                }
            }
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }

        function getCardValue(card) {
            if (card.value === 'A') return 11;
            if (['J', 'Q', 'K'].includes(card.value)) return 10;
            return parseInt(card.value);
        }

        function calculateScore(hand) {
            let score = 0;
            let aces = 0;
            
            for (let card of hand) {
                const val = getCardValue(card);
                score += val;
                if (card.value === 'A') aces++;
            }
            
            while (score > 21 && aces > 0) {
                score -= 10;
                aces--;
            }
            
            return score;
        }

        function isBlackjack(hand) {
            if (hand.length !== 2) return false;
            const score = calculateScore(hand);
            const hasAce = hand.some(c => c.value === 'A');
            const hasTen = hand.some(c => getCardValue(c) === 10);
            return score === 21 && hasAce && hasTen;
        }

        function canSplitCards() {
            return playerHand.length === 2 && 
                   getCardValue(playerHand[0]) === getCardValue(playerHand[1]) &&
                   chips >= currentBet;
        }

        function renderCard(card, hidden = false) {
            const cardEl = document.createElement('div');
            
            if (hidden) {
                cardEl.className = 'card back';
            } else {
                cardEl.className = `card ${card.isRed ? 'red' : 'black'}`;
                cardEl.innerHTML = `
                    <div class="card-value">${card.value}</div>
                    <div class="card-suit">${card.suit}</div>
                `;
            }
            
            return cardEl;
        }

        function updateDisplay(hideDealer = true) {
            const dealerEl = document.getElementById('dealer-cards');
            dealerEl.innerHTML = '';
            dealerHand.forEach((card, i) => {
                dealerEl.appendChild(renderCard(card, hideDealer && i === 1));
            });
            
            const dealerScore = hideDealer ? calculateScore([dealerHand[0]]) : calculateScore(dealerHand);
            document.getElementById('dealer-score').textContent = `Score: ${dealerScore}`;

            const playerEl = document.getElementById('player-cards');
            playerEl.innerHTML = '';
            playerHand.forEach(card => {
                playerEl.appendChild(renderCard(card));
            });
            
            const playerScore = calculateScore(playerHand);
            document.getElementById('player-score').textContent = `Score: ${playerScore}`;
            
            let betText = `Bet: ${currentBet} chips`;
            if (insuranceBet > 0) betText += ` | Insurance: ${insuranceBet} chips`;
            document.getElementById('bet-info').textContent = betText;
            
            return playerScore;
        }

        function showMessage(msg, isBlackjack = false) {
            const msgEl = document.getElementById('message');
            msgEl.textContent = msg;
            msgEl.className = isBlackjack ? 'message blackjack-notice' : 'message';
        }

        function startGame() {
            insuranceBet = 0;
            gameActive = true;
            canDouble = true;

            createDeck();
            playerHand = [deck.pop(), deck.pop()];
            dealerHand = [deck.pop(), deck.pop()];

            updateDisplay(true);
            showMessage('');

            const playerBJ = isBlackjack(playerHand);
            const dealerBJ = isBlackjack(dealerHand);

            if (playerBJ && dealerBJ) {
                setTimeout(() => {
                    updateDisplay(false);
                    showMessage('BOTH BLACKJACK! PUSH', true);
                    chips += currentBet;
                    updateChipsDisplay();
                    showEndButtons();
                }, 500);
                return;
            }

            if (playerBJ) {
                setTimeout(() => {
                    updateDisplay(false);
                    const winnings = Math.floor(currentBet * 1.5);
                    showMessage(`BLACKJACK! +${winnings} chips`, true);
                    chips += currentBet + winnings;
                    updateChipsDisplay();
                    showEndButtons();
                }, 500);
                return;
            }

            if (dealerBJ) {
                setTimeout(() => {
                    updateDisplay(false);
                    showMessage('Dealer BLACKJACK!');
                    showEndButtons();
                }, 500);
                return;
            }

            if (dealerHand[0].value === 'A' && chips >= Math.floor(currentBet / 2)) {
                offerInsurance();
            } else {
                showGameControls();
            }
        }

        function offerInsurance() {
            const insuranceCost = Math.floor(currentBet / 2);
            showMessage(`Insurance?`);
            document.getElementById('controls').innerHTML = `
                <button class="btn btn-insurance" onclick="takeInsurance(${insuranceCost})">Yes (${insuranceCost})</button>
                <button class="btn btn-stand" onclick="declineInsurance()">No</button>
            `;
        }

        function takeInsurance(cost) {
            chips -= cost;
            insuranceBet = cost;
            updateChipsDisplay();
            updateDisplay(true);
            
            if (isBlackjack(dealerHand)) {
                setTimeout(() => {
                    updateDisplay(false);
                    showMessage('Dealer BLACKJACK! Insurance pays 2:1');
                    chips += insuranceBet * 3;
                    updateChipsDisplay();
                    showEndButtons();
                }, 500);
            } else {
                showMessage('Insurance lost.');
                setTimeout(() => showGameControls(), 1000);
            }
        }

        function declineInsurance() {
            showGameControls();
        }

        function showGameControls() {
            canSplit = canSplitCards();
            
            let html = `
                <button class="btn btn-hit" onclick="hit()">üëá HIT</button>
                <button class="btn btn-stand" onclick="stand()">‚úã STAND</button>
            `;
            
            if (canDouble && chips >= currentBet) {
                html += `<button class="btn btn-double" onclick="doubleDown()">2Ô∏è‚É£ DOUBLE</button>`;
            }
            
            if (canSplit) {
                html += `<button class="btn btn-split" onclick="split()">‚úåÔ∏è SPLIT</button>`;
            }
            
            document.getElementById('controls').innerHTML = html;
            showMessage('Your turn');
        }

        function hit() {
            if (!gameActive) return;
            
            canDouble = false;
            canSplit = false;
            
            playerHand.push(deck.pop());
            const score = updateDisplay(true);
            
            if (score > 21) {
                setTimeout(() => endGame('bust'), 400);
            } else if (score === 21) {
                setTimeout(() => stand(), 400);
            } else {
                showGameControls();
            }
        }

        function stand() {
            if (!gameActive) return;
            
            gameActive = false;
            canDouble = false;
            canSplit = false;
            updateDisplay(false);
            showMessage('Dealer\'s turn');

            let dealerScore = calculateScore(dealerHand);
            
            const dealerTurn = () => {
                if (dealerScore < 17) {
                    setTimeout(() => {
                        dealerHand.push(deck.pop());
                        dealerScore = calculateScore(dealerHand);
                        updateDisplay(false);
                        if (isSplitGame) {
                            updateSplitDisplay();
                        }
                        dealerTurn();
                    }, 700);
                } else {
                    if (isSplitGame) {
                        setTimeout(() => endSplitGame(dealerScore), 700);
                    } else {
                        setTimeout(() => endGame('compare'), 700);
                    }
                }
            };
            
            dealerTurn();
        }

        function endSplitGame(dealerScore) {
            let totalWinnings = 0;
            let results = [];
            
            for (let i = 0; i < 2; i++) {
                const playerScore = calculateScore(splitHands[i]);
                const bet = splitBets[i];
                let result = '';
                let winnings = 0;
                
                if (playerScore > 21) {
                    result = 'BUST';
                    winnings = 0;
                } else if (dealerScore > 21) {
                    result = 'WIN';
                    if (isBlackjack(splitHands[i])) {
                        winnings = bet + Math.floor(bet * 1.5);
                    } else {
                        winnings = bet * 2;
                    }
                } else if (playerScore > dealerScore) {
                    result = 'WIN';
                    if (isBlackjack(splitHands[i])) {
                        winnings = bet + Math.floor(bet * 1.5);
                    } else {
                        winnings = bet * 2;
                    }
                } else if (playerScore < dealerScore) {
                    result = 'LOSE';
                    winnings = 0;
                } else {
                    result = 'PUSH';
                    winnings = bet;
                }
                
                totalWinnings += winnings;
                results.push(`Hand ${i + 1}: ${result}`);
            }
            
            chips += totalWinnings;
            updateChipsDisplay();
            
            const netResult = totalWinnings - (splitBets[0] + splitBets[1]);
            let finalMessage = results.join(' | ');
            if (netResult > 0) {
                finalMessage += ` | +${netResult} chips`;
            } else if (netResult < 0) {
                finalMessage += ` | ${netResult} chips`;
            }
            
            showMessage(finalMessage);
            showEndButtons();
        }

        function doubleDown() {
            if (!gameActive || chips < currentBet) return;
            
            chips -= currentBet;
            currentBet *= 2;
            updateChipsDisplay();
            
            playerHand.push(deck.pop());
            const score = updateDisplay(true);
            
            if (score > 21) {
                setTimeout(() => endGame('bust'), 400);
            } else {
                setTimeout(() => stand(), 400);
            }
        }

        function split() {
            if (!canSplit || chips < currentBet) return;
            
            // Deduct second bet
            chips -= currentBet;
            updateChipsDisplay();
            
            // Set split mode
            isSplitGame = true;
            splitBets = [currentBet, currentBet];
            
            // Split the cards
            splitHands[0] = [playerHand[0]];
            splitHands[1] = [playerHand[1]];
            
            // Deal one card to each hand
            splitHands[0].push(deck.pop());
            splitHands[1].push(deck.pop());
            
            // Check if splitting aces
            const splittingAces = playerHand[0].value === 'A';
            
            // Reset state
            currentSplitHand = 0;
            splitComplete = [false, false];
            
            // Hide normal display, show split display
            document.getElementById('player-cards-container').style.display = 'none';
            document.getElementById('split-container').style.display = 'block';
            document.getElementById('player-score').style.display = 'none';
            
            updateSplitDisplay();
            
            // If aces, both hands complete immediately
            if (splittingAces) {
                splitComplete = [true, true];
                showMessage('Aces split - one card each');
                setTimeout(() => {
                    updateSplitDisplay();
                    stand();
                }, 1000);
            } else {
                // Check for blackjack on first hand
                if (isBlackjack(splitHands[0])) {
                    splitComplete[0] = true;
                    currentSplitHand = 1;
                    updateSplitDisplay();
                    showMessage('Hand 1: BLACKJACK!');
                    setTimeout(() => {
                        if (isBlackjack(splitHands[1])) {
                            splitComplete[1] = true;
                            showMessage('Hand 2: BLACKJACK!');
                            setTimeout(() => stand(), 1000);
                        } else {
                            showSplitControls();
                        }
                    }, 1500);
                } else {
                    showSplitControls();
                }
            }
        }

        function updateSplitDisplay() {
            // Update both hands
            for (let i = 0; i < 2; i++) {
                const cardsEl = document.getElementById(`split-cards-${i}`);
                cardsEl.innerHTML = '';
                splitHands[i].forEach(card => {
                    cardsEl.appendChild(renderCard(card));
                });
                
                const score = calculateScore(splitHands[i]);
                document.getElementById(`split-score-${i}`).textContent = `Score: ${score}`;
                
                const handEl = document.getElementById(`split-hand-${i}`);
                handEl.classList.remove('active', 'complete');
                
                if (splitComplete[i]) {
                    handEl.classList.add('complete');
                } else if (i === currentSplitHand) {
                    handEl.classList.add('active');
                }
            }
        }

        function showSplitControls() {
            const currentHand = splitHands[currentSplitHand];
            const score = calculateScore(currentHand);
            
            showMessage(`Hand ${currentSplitHand + 1} - Your turn`);
            
            let html = `
                <button class="btn btn-hit" onclick="splitHit()">üëá HIT</button>
                <button class="btn btn-stand" onclick="splitStand()">‚úã STAND</button>
            `;
            
            // Allow double if only 2 cards
            if (currentHand.length === 2 && chips >= splitBets[currentSplitHand]) {
                html += `<button class="btn btn-double" onclick="splitDouble()">2Ô∏è‚É£ DOUBLE</button>`;
            }
            
            document.getElementById('controls').innerHTML = html;
        }

        function splitHit() {
            const hand = splitHands[currentSplitHand];
            hand.push(deck.pop());
            updateSplitDisplay();
            
            const score = calculateScore(hand);
            
            if (score > 21) {
                splitComplete[currentSplitHand] = true;
                showMessage(`Hand ${currentSplitHand + 1}: BUST!`);
                setTimeout(() => moveToNextSplitHand(), 1000);
            } else if (score === 21) {
                splitComplete[currentSplitHand] = true;
                setTimeout(() => moveToNextSplitHand(), 500);
            } else {
                showSplitControls();
            }
        }

        function splitStand() {
            splitComplete[currentSplitHand] = true;
            updateSplitDisplay();
            moveToNextSplitHand();
        }

        function splitDouble() {
            const bet = splitBets[currentSplitHand];
            if (chips < bet) return;
            
            chips -= bet;
            splitBets[currentSplitHand] *= 2;
            updateChipsDisplay();
            
            const hand = splitHands[currentSplitHand];
            hand.push(deck.pop());
            updateSplitDisplay();
            
            const score = calculateScore(hand);
            splitComplete[currentSplitHand] = true;
            
            if (score > 21) {
                showMessage(`Hand ${currentSplitHand + 1}: BUST!`);
            }
            
            setTimeout(() => moveToNextSplitHand(), 1000);
        }

        function moveToNextSplitHand() {
            if (currentSplitHand === 0 && !splitComplete[1]) {
                currentSplitHand = 1;
                updateSplitDisplay();
                
                if (isBlackjack(splitHands[1])) {
                    splitComplete[1] = true;
                    showMessage('Hand 2: BLACKJACK!');
                    setTimeout(() => stand(), 1500);
                } else {
                    showSplitControls();
                }
            } else {
                // Both hands complete, dealer plays
                stand();
            }
        }

        function endGame(reason) {
            gameActive = false;

            const playerScore = calculateScore(playerHand);
            const dealerScore = calculateScore(dealerHand);

            let result = '';

            if (reason === 'bust') {
                result = 'BUST!';
            } else if (dealerScore > 21) {
                result = 'VICTORY! Dealer busts';
                chips += currentBet * 2;
            } else if (playerScore > dealerScore) {
                result = 'VICTORY!';
                chips += currentBet * 2;
            } else if (playerScore < dealerScore) {
                result = 'DEFEAT!';
            } else {
                result = 'PUSH';
                chips += currentBet;
            }

            updateChipsDisplay();
            showMessage(result);
            showEndButtons();
        }

        function showEndButtons() {
            document.getElementById('controls').innerHTML = '<button class="btn btn-deal" onclick="backToBetting()">Deal Again</button>';
        }

        loadChips();
    </script>
</body>
</html>
